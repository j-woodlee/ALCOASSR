{"version":3,"sources":["../../../lib/utils/xml-stream.js"],"names":["_","require","utils","OPEN_ANGLE","CLOSE_ANGLE","OPEN_ANGLE_SLASH","CLOSE_SLASH_ANGLE","EQUALS_QUOTE","QUOTE","SPACE","pushAttribute","xml","name","value","push","xmlEncode","toString","pushAttributes","attributes","each","undefined","XmlStream","module","exports","_xml","_stack","_rollbacks","StdDocAttributes","version","encoding","standalone","prototype","tos","length","openXml","docAttributes","openNode","parent","open","leaf","addAttribute","Error","addAttributes","attrs","writeText","text","writeXml","closeNode","node","pop","leafNode","closeAll","addRollback","stack","commit","rollback","r","splice","join"],"mappings":"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","sourcesContent":["'use strict';\n\nconst _ = require('./under-dash');\n\nconst utils = require('./utils');\n\n// constants\nconst OPEN_ANGLE = '<';\nconst CLOSE_ANGLE = '>';\nconst OPEN_ANGLE_SLASH = '</';\nconst CLOSE_SLASH_ANGLE = '/>';\nconst EQUALS_QUOTE = '=\"';\nconst QUOTE = '\"';\nconst SPACE = ' ';\n\nfunction pushAttribute(xml, name, value) {\n  xml.push(SPACE);\n  xml.push(name);\n  xml.push(EQUALS_QUOTE);\n  xml.push(utils.xmlEncode(value.toString()));\n  xml.push(QUOTE);\n}\nfunction pushAttributes(xml, attributes) {\n  if (attributes) {\n    _.each(attributes, (value, name) => {\n      if (value !== undefined) {\n        pushAttribute(xml, name, value);\n      }\n    });\n  }\n}\n\nconst XmlStream = (module.exports = function() {\n  this._xml = [];\n  this._stack = [];\n  this._rollbacks = [];\n});\n\nXmlStream.StdDocAttributes = {\n  version: '1.0',\n  encoding: 'UTF-8',\n  standalone: 'yes',\n};\n\nXmlStream.prototype = {\n  get tos() {\n    return this._stack.length ? this._stack[this._stack.length - 1] : undefined;\n  },\n\n  openXml(docAttributes) {\n    const xml = this._xml;\n    // <?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>\n    xml.push('<?xml');\n    pushAttributes(xml, docAttributes);\n    xml.push('?>\\n');\n  },\n\n  openNode(name, attributes) {\n    const parent = this.tos;\n    const xml = this._xml;\n    if (parent && this.open) {\n      xml.push(CLOSE_ANGLE);\n    }\n\n    this._stack.push(name);\n\n    // start streaming node\n    xml.push(OPEN_ANGLE);\n    xml.push(name);\n    pushAttributes(xml, attributes);\n    this.leaf = true;\n    this.open = true;\n  },\n  addAttribute(name, value) {\n    if (!this.open) {\n      throw new Error('Cannot write attributes to node if it is not open');\n    }\n    pushAttribute(this._xml, name, value);\n  },\n  addAttributes(attrs) {\n    if (!this.open) {\n      throw new Error('Cannot write attributes to node if it is not open');\n    }\n    pushAttributes(this._xml, attrs);\n  },\n  writeText(text) {\n    const xml = this._xml;\n    if (this.open) {\n      xml.push(CLOSE_ANGLE);\n      this.open = false;\n    }\n    this.leaf = false;\n    xml.push(utils.xmlEncode(text.toString()));\n  },\n  writeXml(xml) {\n    if (this.open) {\n      this._xml.push(CLOSE_ANGLE);\n      this.open = false;\n    }\n    this.leaf = false;\n    this._xml.push(xml);\n  },\n  closeNode() {\n    const node = this._stack.pop();\n    const xml = this._xml;\n    if (this.leaf) {\n      xml.push(CLOSE_SLASH_ANGLE);\n    } else {\n      xml.push(OPEN_ANGLE_SLASH);\n      xml.push(node);\n      xml.push(CLOSE_ANGLE);\n    }\n    this.open = false;\n    this.leaf = false;\n  },\n  leafNode(name, attributes, text) {\n    this.openNode(name, attributes);\n    if (text !== undefined) {\n      // zeros need to be written\n      this.writeText(text);\n    }\n    this.closeNode();\n  },\n\n  closeAll() {\n    while (this._stack.length) {\n      this.closeNode();\n    }\n  },\n\n  addRollback() {\n    this._rollbacks.push({\n      xml: this._xml.length,\n      stack: this._stack.length,\n      leaf: this.leaf,\n      open: this.open,\n    });\n  },\n  commit() {\n    this._rollbacks.pop();\n  },\n  rollback() {\n    const r = this._rollbacks.pop();\n    if (this._xml.length > r.xml) {\n      this._xml.splice(r.xml, this._xml.length - r.xml);\n    }\n    if (this._stack.length > r.stack) {\n      this._stack.splice(r.stack, this._stack.length - r.stack);\n    }\n    this.leaf = r.leaf;\n    this.open = r.open;\n  },\n\n  get xml() {\n    this.closeAll();\n    return this._xml.join('');\n  },\n};\n"],"file":"xml-stream.js"}